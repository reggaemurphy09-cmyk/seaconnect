<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SeaConnect - Messages</title>

<style>
body{
margin:0;
font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;
background:linear-gradient(180deg,#0f172a,#1e293b);
color:#f1f5f9;
}

.container{
padding:20px;
padding-bottom:110px;
}

.card{
background:rgba(255,255,255,0.06);
backdrop-filter:blur(12px);
border:1px solid rgba(255,255,255,0.08);
padding:18px;
border-radius:22px;
margin-bottom:16px;
box-shadow:0 10px 30px rgba(0,0,0,.35);
}

.chatListItem{cursor:pointer;}
.chatListItem:hover{background:rgba(255,255,255,0.05);}

.listRow{
display:flex;
gap:12px;
align-items:center;
}

.avatarWrapper{
position:relative;
width:50px;
height:50px;
}

.avatarWrapper img{
width:50px;
height:50px;
border-radius:50%;
object-fit:cover;
}

.onlineRing{
position:absolute;
top:0;
left:0;
width:50px;
height:50px;
border-radius:50%;
border:2px solid #22c55e;
pointer-events:none;
}

.listText{flex:1;}
.listName{font-weight:900;}

.listSub{
font-size:13px;
color:#94a3b8;
margin-top:3px;
}

.chatBox{
height:50vh;
overflow:auto;
margin-bottom:10px;
}

.message{
display:flex;
margin:6px 0;
}

.message.me{justify-content:flex-end;}

.bubble{
max-width:70%;
padding:10px 14px;
border-radius:20px;
font-size:14px;
word-wrap:break-word;
}

.me .bubble{
background:#3b82f6;
color:#fff;
border-bottom-right-radius:6px;
}

.other .bubble{
background:rgba(255,255,255,0.1);
border-bottom-left-radius:6px;
}

.time{
font-size:10px;
opacity:.6;
margin-top:3px;
}

input{
width:100%;
padding:12px;
border-radius:14px;
border:1px solid rgba(255,255,255,0.15);
margin-top:8px;
background:rgba(255,255,255,0.05);
color:#fff;
}

button{
padding:11px 16px;
border:none;
border-radius:14px;
font-weight:700;
cursor:pointer;
}

.primary{
background:linear-gradient(135deg,#3b82f6,#2563eb);
color:#fff;
}

.light{
background:rgba(255,255,255,0.1);
color:#fff;
}

.danger{
background:linear-gradient(135deg,#ef4444,#dc2626);
color:#fff;
}

.row{
display:flex;
gap:10px;
margin-top:10px;
}

.bottomnav{
position:fixed;
bottom:15px;
left:50%;
transform:translateX(-50%);
width:90%;
height:65px;
background:rgba(15,23,42,0.9);
backdrop-filter:blur(10px);
border-radius:22px;
display:flex;
justify-content:space-around;
align-items:center;
box-shadow:0 10px 40px rgba(0,0,0,.6);
}

.bottomnav button{
background:none;
border:none;
font-size:12px;
font-weight:600;
color:#94a3b8;
}

.bottomnav button.active{
color:#3b82f6;
font-weight:800;
}
</style>
</head>

<body>

<div class="container">

<div id="chatListSection">
<h2>ðŸ’¬ Messages</h2>
<div id="chatList"></div>
</div>

<div id="chatSection" style="display:none;">

<div class="card">

<div style="display:flex;justify-content:space-between;">
<div id="chatTitle" style="font-weight:900;"></div>
<button class="danger" id="deleteChatBtn">Delete</button>
</div>

<div id="messagesBox" class="chatBox"></div>

<input id="messageInput" placeholder="Type message...">

<div class="row">
<button class="primary" id="sendBtn">Send</button>
<button class="light" id="closeBtn">Close</button>
</div>

</div>

</div>

</div>

<div class="bottomnav">
<button onclick="location.href='feeds.html'">ðŸ“° Feeds</button>
<button onclick="location.href='friends.html'">ðŸ‘¥ Friends</button>
<button class="active">ðŸ’¬ Messages</button>
<button onclick="location.href='profile.html'">ðŸ‘¤ Profile</button>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth,onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import {
getFirestore,
collection,
addDoc,
query,
orderBy,
onSnapshot,
doc,
getDoc,
deleteDoc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig={
apiKey:"AIzaSyCNlodsmEHrSXxgH0gTOcx4cAXwG8qmG9w",
authDomain:"seaconnect-d2baa.firebaseapp.com",
projectId:"seaconnect-d2baa"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

let currentEmail=null;
let currentChat=null;
let chatUserEmail=null;
let isSending=false;

const chatList=document.getElementById("chatList");
const messagesBox=document.getElementById("messagesBox");
const chatSection=document.getElementById("chatSection");

function chatId(a,b){
return [a,b].sort().join("_");
}

onAuthStateChanged(auth,(user)=>{

if(!user){
location.href="index.html";
return;
}

currentEmail=user.email.toLowerCase();

listenChats();

/* open chat from friends */

const params=new URLSearchParams(window.location.search);
const openUser=params.get("user");

if(openUser){
openChat(openUser.toLowerCase());
}

});

async function listenChats(){

const q=query(collection(db,"messages"),orderBy("createdAt"));

onSnapshot(q,async snap=>{

const chats={};

snap.forEach(docSnap=>{

const d=docSnap.data();

if(d.from!==currentEmail && d.to!==currentEmail) return;

const other=d.from===currentEmail?d.to:d.from;

chats[other]=d;

});

chatList.innerHTML="";

for(const email in chats){

const last=chats[email];

let name=email.split("@")[0];

try{
const userSnap=await getDoc(doc(db,"users",email));
name=userSnap.data()?.name || name;
}catch{}

chatList.innerHTML+=`

<div class="card chatListItem" onclick="openChat('${email}')">

<div class="listRow">

<div class="avatarWrapper">
<img src="https://i.ibb.co/2kRZ7Z6/avatar.png">
<div class="onlineRing"></div>
</div>

<div class="listText">
<div class="listName">${name}</div>
<div class="listSub">${last.text}</div>
</div>

</div>

</div>

`;

}

});

}

window.openChat=function(email){

chatUserEmail=email;
currentChat=chatId(currentEmail,email);

chatSection.style.display="block";

loadMessages();

};

function loadMessages(){

const q=query(collection(db,"messages"),orderBy("createdAt"));

onSnapshot(q,(snap)=>{

messagesBox.innerHTML="";

snap.forEach(docSnap=>{

const d=docSnap.data();

if(d.chatId!==currentChat) return;

const me=d.from===currentEmail;

const time=new Date(d.createdAt).toLocaleTimeString([],{
hour:'2-digit',
minute:'2-digit'
});

messagesBox.innerHTML+=`

<div class="message ${me?'me':'other'}">

<div class="bubble">
${d.text}
<div class="time">${time}</div>
</div>

</div>

`;

});

messagesBox.scrollTop=messagesBox.scrollHeight;

});

}

sendBtn.onclick=async()=>{

if(isSending) return;

const text=messageInput.value.trim();
if(!text) return;

isSending=true;

/* instant message bubble */

const time=new Date().toLocaleTimeString([],{
hour:'2-digit',
minute:'2-digit'
});

messagesBox.innerHTML+=`
<div class="message me">
<div class="bubble">
${text}
<div class="time">${time}</div>
</div>
</div>
`;

messagesBox.scrollTop=messagesBox.scrollHeight;

await addDoc(collection(db,"messages"),{
chatId:currentChat,
from:currentEmail,
to:chatUserEmail,
text:text,
createdAt:Date.now()
});

messageInput.value="";
isSending=false;

};

closeBtn.onclick=()=>{
chatSection.style.display="none";
};

deleteChatBtn.onclick=async()=>{

if(!confirm("Delete chat?")) return;

const q=query(collection(db,"messages"));

onSnapshot(q,(snap)=>{

snap.forEach(async docSnap=>{

if(docSnap.data().chatId===currentChat){
await deleteDoc(doc(db,"messages",docSnap.id));
}

});

});

chatSection.style.display="none";

};

</script>

</body>
</html>
