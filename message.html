<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SeaConnect Messenger</title>

<style>

body{
margin:0;
font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;
background:#0f172a;
color:#fff;
}

/* HEADER */

.chatHeader{
position:fixed;
top:0;
left:0;
right:0;
height:60px;
display:flex;
align-items:center;
gap:12px;
padding:0 15px;
background:#0f172a;
border-bottom:1px solid rgba(255,255,255,0.1);
}

.chatHeader button{
background:none;
border:none;
font-size:22px;
color:white;
}

.chatHeader img{
width:40px;
height:40px;
border-radius:50%;
object-fit:cover;
}

.chatTitle{font-weight:900;}
.chatRank{font-size:12px;opacity:.6}

/* CHAT AREA */

.chatArea{
position:fixed;
top:60px;
bottom:90px;
left:0;
right:0;
overflow:auto;
padding:15px;
}

/* MESSAGE */

.message{
display:flex;
gap:10px;
margin-bottom:12px;
}

.message.me{
justify-content:flex-end;
}

.avatar{
width:34px;
height:34px;
border-radius:50%;
object-fit:cover;
}

.bubble{
background:#e5e7eb;
color:#111;
padding:10px 14px;
border-radius:18px;
max-width:70%;
font-size:14px;
}

.message.me .bubble{
background:white;
}

.chatPhoto{
max-width:200px;
border-radius:10px;
margin-top:5px;
}

.time{
font-size:10px;
opacity:.6;
margin-top:4px;
}

/* INPUT BAR */

.chatInput{
position:fixed;
bottom:0;
left:0;
right:0;
background:#0f172a;
border-top:1px solid rgba(255,255,255,0.1);
padding:10px;
}

.preview{
max-width:120px;
border-radius:10px;
margin-bottom:6px;
}

/* INPUT ROW */

.inputRow{
display:flex;
gap:10px;
align-items:center;
}

.inputRow input{
flex:1;
padding:12px;
border-radius:20px;
border:none;
background:#1e293b;
color:white;
}

.inputRow button{
background:none;
border:none;
font-size:22px;
color:white;
}

</style>
</head>

<body>

<div class="chatHeader">

<button onclick="history.back()">←</button>

<img id="chatAvatar" src="https://i.ibb.co/2kRZ7Z6/avatar.png">

<div>
<div class="chatTitle" id="chatTitle">Loading...</div>
<div class="chatRank" id="chatRank"></div>
</div>

</div>

<div class="chatArea" id="chatArea"></div>

<div class="chatInput">

<img id="previewImage" class="preview" style="display:none">

<div class="inputRow">

<button onclick="photoInput.click()">+</button>

<input id="messageInput" placeholder="Type message...">

<button id="sendBtn">↑</button>

<input type="file" id="photoInput" accept="image/*" style="display:none">

</div>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth,onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import {
getFirestore,
collection,
addDoc,
query,
orderBy,
onSnapshot,
doc,
getDocs,
updateDoc,
where
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig={
apiKey:"AIzaSyCNlodsmEHrSXxgH0gTOcx4cAXwG8qmG9w",
authDomain:"seaconnect-d2baa.firebaseapp.com",
projectId:"seaconnect-d2baa"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

const IMGBB_KEY="5b417e8de4a883f7425eeda12dc38f06";

let currentEmail;
let chatUserEmail;
let currentChat;
let sending=false;

let myPhoto="https://i.ibb.co/2kRZ7Z6/avatar.png";
let otherPhoto="https://i.ibb.co/2kRZ7Z6/avatar.png";

const chatArea=document.getElementById("chatArea");
const previewImage=document.getElementById("previewImage");

function chatId(a,b){
return [a,b].sort().join("_");
}

/* LOGIN */

onAuthStateChanged(auth,async(user)=>{

if(!user){
location.href="index.html";
return;
}

currentEmail=user.email.toLowerCase();

/* load my profile */
const me=await getProfile(currentEmail);
myPhoto=me.photo;

const params=new URLSearchParams(window.location.search);
const openUser=params.get("user");

if(openUser){
openChat(openUser.toLowerCase());
}

});

/* GET PROFILE */

async function getProfile(email){

let name=email.split("@")[0];
let rank="";
let photo="https://i.ibb.co/2kRZ7Z6/avatar.png";

const snap=await getDocs(collection(db,"users"));

snap.forEach(docSnap=>{
const d=docSnap.data();
if(d.email===email){
name=d.name||name;
rank=d.rank||"";
photo=d.photo||photo;
}
});

return {name,rank,photo};

}

/* OPEN CHAT */

async function openChat(email){

chatUserEmail=email;
currentChat=chatId(currentEmail,email);

/* load messages instantly */
loadMessages();

/* load profile in background */
const profile=await getProfile(email);

chatTitle.innerText=profile.name;
chatRank.innerText=profile.rank;
chatAvatar.src=profile.photo;

otherPhoto=profile.photo;

}

/* LOAD MESSAGES */

function loadMessages(){

const q=query(
collection(db,"messages"),
where("chatId","==",currentChat),
orderBy("createdAt")
);

onSnapshot(q,(snap)=>{

chatArea.innerHTML="";

snap.forEach(docSnap=>{

const d=docSnap.data();

const me=d.from===currentEmail;
const avatar=me?myPhoto:otherPhoto;

const time=new Date(d.createdAt).toLocaleTimeString([],{
hour:'2-digit',
minute:'2-digit'
});

chatArea.innerHTML+=`

<div class="message ${me?'me':''}">

${!me?`<img class="avatar" src="${avatar}">`:''}

<div class="bubble">

${d.text||""}

${d.photo?`<img src="${d.photo}" class="chatPhoto">`:""}

<div class="time">${time}</div>

</div>

</div>

`;

});

chatArea.scrollTop=chatArea.scrollHeight;

});

}

/* PHOTO PREVIEW */

photoInput.onchange=()=>{

const file=photoInput.files[0];

if(file){
previewImage.src=URL.createObjectURL(file);
previewImage.style.display="block";
}

}

/* SEND MESSAGE */

sendBtn.onclick=async()=>{

if(sending) return;

const text=messageInput.value.trim();
const file=photoInput.files[0];

if(!text && !file) return;

sending=true;

let preview="";

if(file){
preview=URL.createObjectURL(file);
}

const ref=await addDoc(collection(db,"messages"),{

chatId:currentChat,
from:currentEmail,
to:chatUserEmail,
text:text,
photo:preview,
createdAt:Date.now()

});

messageInput.value="";
previewImage.style.display="none";
photoInput.value="";

/* upload background */

if(file){

const formData=new FormData();
formData.append("image",file);

const res=await fetch(
"https://api.imgbb.com/1/upload?key="+IMGBB_KEY,
{method:"POST",body:formData}
);

const data=await res.json();

if(data.success){

await updateDoc(doc(db,"messages",ref.id),{
photo:data.data.url
});

}

}

sending=false;

}

</script>

</body>
</html>
