<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>SeaConnect Messenger</title>

<style>

body{
margin:0;
font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;
background:#f3f4f6;
color:#111;
}

/* HEADER */

.header{
position:fixed;
top:0;
left:0;
right:0;
height:60px;
background:white;
border-bottom:1px solid #e5e7eb;
display:flex;
align-items:center;
gap:12px;
padding:0 12px;
z-index:10;
}

.header button{
background:none;
border:none;
font-size:22px;
cursor:pointer;
}

.header img{
width:38px;
height:38px;
border-radius:50%;
object-fit:cover;
}

.title{
font-weight:700;
}

.rank{
font-size:12px;
color:#6b7280;
}

/* CHAT AREA */

.chat{
position:fixed;
top:60px;
bottom:80px;
left:0;
right:0;
overflow:auto;
padding:15px;
}

/* MESSAGE */

.msg{
display:flex;
gap:8px;
margin-bottom:12px;
}

.msg.me{
justify-content:flex-end;
}

.avatar{
width:30px;
height:30px;
border-radius:50%;
object-fit:cover;
}

.bubble{
background:#e5e7eb;
padding:10px 14px;
border-radius:18px;
max-width:70%;
font-size:14px;
}

.msg.me .bubble{
background:white;
border:1px solid #e5e7eb;
}

.photo{
max-width:200px;
border-radius:10px;
margin-top:5px;
}

.time{
font-size:10px;
color:#6b7280;
margin-top:3px;
}

/* INPUT */

.input{
position:fixed;
bottom:0;
left:0;
right:0;
background:white;
border-top:1px solid #e5e7eb;
padding:10px;
}

.preview{
max-width:120px;
border-radius:10px;
margin-bottom:6px;
}

.row{
display:flex;
gap:8px;
align-items:center;
}

.row input{
flex:1;
padding:12px;
border-radius:20px;
border:1px solid #e5e7eb;
outline:none;
}

.row button{
background:none;
border:none;
font-size:22px;
cursor:pointer;
}

</style>
</head>

<body>

<div class="header">

<button onclick="history.back()">←</button>

<img id="avatar" src="https://i.ibb.co/2kRZ7Z6/avatar.png">

<div>
<div class="title" id="name">Loading</div>
<div class="rank" id="rank"></div>
</div>

</div>

<div class="chat" id="chat"></div>

<div class="input">

<img id="preview" class="preview" style="display:none">

<div class="row">

<button onclick="file.click()">+</button>

<input id="text" placeholder="Type message">

<button id="send">↑</button>

<input type="file" id="file" style="display:none" accept="image/*">

</div>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth,onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import {
getFirestore,
collection,
addDoc,
query,
where,
orderBy,
onSnapshot,
getDocs,
doc,
updateDoc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig={
apiKey:"AIzaSyCNlodsmEHrSXxgH0gTOcx4cAXwG8qmG9w",
authDomain:"seaconnect-d2baa.firebaseapp.com",
projectId:"seaconnect-d2baa"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

const IMGBB_KEY="5b417e8de4a883f7425eeda12dc38f06";

let myEmail;
let otherEmail;
let chatId;
let sending=false;

const chat=document.getElementById("chat");
const text=document.getElementById("text");
const file=document.getElementById("file");
const preview=document.getElementById("preview");

/* LOGIN */

onAuthStateChanged(auth,(user)=>{

if(!user){
location.href="index.html";
return;
}

myEmail=user.email.toLowerCase();

const params=new URLSearchParams(location.search);
otherEmail=params.get("user");

chatId=[myEmail,otherEmail].sort().join("_");

loadProfile();
listenMessages();

});

/* PROFILE */

async function loadProfile(){

const snap=await getDocs(collection(db,"users"));

snap.forEach(d=>{

const data=d.data();

if(data.email===otherEmail){

name.innerText=data.name;
rank.innerText=data.rank;
avatar.src=data.photo;

}

});

}

/* MESSAGES */

function listenMessages(){

const q=query(
collection(db,"messages"),
where("chatId","==",chatId),
orderBy("createdAt")
);

onSnapshot(q,(snap)=>{

chat.innerHTML="";

snap.forEach(doc=>{

const d=doc.data();

const me=d.from===myEmail;

const time=new Date(d.createdAt).toLocaleTimeString([],{
hour:'2-digit',
minute:'2-digit'
});

chat.innerHTML+=`

<div class="msg ${me?'me':''}">

${!me?`<img class="avatar" src="${avatar.src}">`:''}

<div class="bubble">

${d.text||""}

${d.photo?`<img src="${d.photo}" class="photo">`:""}

<div class="time">${time}</div>

</div>

</div>

`;

});

chat.scrollTop=chat.scrollHeight;

});

}

/* PREVIEW */

file.onchange=()=>{

const f=file.files[0];

if(!f)return;

preview.src=URL.createObjectURL(f);
preview.style.display="block";

};

/* SEND */

send.onclick=async()=>{

if(sending)return;

const message=text.value.trim();
const f=file.files[0];

if(!message && !f)return;

sending=true;

let previewURL="";

if(f){
previewURL=URL.createObjectURL(f);
}

const ref=await addDoc(collection(db,"messages"),{

chatId:chatId,
from:myEmail,
to:otherEmail,
text:message,
photo:previewURL,
createdAt:Date.now()

});

text.value="";
file.value="";
preview.style.display="none";

/* upload background */

if(f){

const form=new FormData();
form.append("image",f);

const res=await fetch(
"https://api.imgbb.com/1/upload?key="+IMGBB_KEY,
{method:"POST",body:form}
);

const data=await res.json();

if(data.success){

await updateDoc(doc(db,"messages",ref.id),{
photo:data.data.url
});

}

}

sending=false;

};

</script>

</body>
</html>
