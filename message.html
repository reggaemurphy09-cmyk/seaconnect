<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SeaConnect Messages</title>

<style>

body{
margin:0;
font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;
background:#0f172a;
color:white;
}

.container{
padding:20px;
padding-bottom:100px;
}

.card{
background:rgba(255,255,255,0.06);
padding:16px;
border-radius:18px;
margin-bottom:12px;
cursor:pointer;
}

.listRow{
display:flex;
align-items:center;
gap:12px;
}

.avatar{
width:50px;
height:50px;
border-radius:50%;
object-fit:cover;
}

.name{
font-weight:900;
}

.rank{
font-size:12px;
opacity:.6;
}

.last{
font-size:13px;
opacity:.6;
}

.chatBox{
position:fixed;
top:0;
left:0;
right:0;
bottom:0;
background:#0f172a;
display:none;
flex-direction:column;
}

.chatHeader{
display:flex;
align-items:center;
gap:12px;
padding:14px;
border-bottom:1px solid rgba(255,255,255,0.1);
}

.chatHeader img{
width:40px;
height:40px;
border-radius:50%;
}

.chatArea{
flex:1;
overflow:auto;
padding:15px;
}

.message{
margin:8px 0;
display:flex;
}

.me{
justify-content:flex-end;
}

.bubble{
max-width:70%;
padding:10px 14px;
border-radius:14px;
background:#1e293b;
}

.me .bubble{
background:#3b82f6;
}

.chatPhoto{
max-width:200px;
border-radius:10px;
margin-top:5px;
}

.time{
font-size:10px;
opacity:.6;
margin-top:3px;
}

.chatInput{
display:flex;
gap:10px;
padding:12px;
border-top:1px solid rgba(255,255,255,0.1);
}

.chatInput input{
flex:1;
padding:12px;
border-radius:20px;
border:none;
background:#1e293b;
color:white;
}

.chatInput button{
border:none;
background:#3b82f6;
color:white;
padding:10px 14px;
border-radius:12px;
cursor:pointer;
}

</style>
</head>

<body>

<div class="container">

<h2>üí¨ Messages</h2>

<div id="chatList"></div>

</div>


<div id="chatBox" class="chatBox">

<div class="chatHeader">
<button onclick="closeChat()">‚Üê</button>

<img id="chatAvatar">

<div>
<div id="chatName"></div>
<div id="chatRank" class="rank"></div>
</div>

</div>

<div id="chatArea" class="chatArea"></div>

<div class="chatInput">

<input id="messageInput" placeholder="Type message">

<input type="file" id="photoInput">

<button id="sendBtn">Send</button>

</div>

</div>


<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";

import {
getAuth,
onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
getFirestore,
collection,
addDoc,
query,
orderBy,
onSnapshot,
getDocs
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig={
apiKey:"AIzaSyCNlodsmEHrSXxgH0gTOcx4cAXwG8qmG9w",
authDomain:"seaconnect-d2baa.firebaseapp.com",
projectId:"seaconnect-d2baa"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

let currentEmail=null;
let currentChat=null;
let chatUser=null;

const chatList=document.getElementById("chatList");
const chatArea=document.getElementById("chatArea");

function chatId(a,b){
return [a,b].sort().join("_");
}

onAuthStateChanged(auth,(user)=>{

if(!user){
location.href="index.html";
return;
}

currentEmail=user.email.toLowerCase();

listenChats();

});

async function getProfile(email){

let name=email.split("@")[0];
let rank="";
let photo="https://i.ibb.co/2kRZ7Z6/avatar.png";

const snap=await getDocs(collection(db,"users"));

snap.forEach(docSnap=>{

const d=docSnap.data();

if(d.email===email){

name=d.name||name;
rank=d.rank||"";
photo=d.photo||photo;

}

});

return {name,rank,photo};

}

function listenChats(){

const q=query(collection(db,"messages"),orderBy("createdAt"));

onSnapshot(q,async snap=>{

const chats={};

snap.forEach(docSnap=>{

const d=docSnap.data();

if(d.from!==currentEmail && d.to!==currentEmail) return;

const other=d.from===currentEmail?d.to:d.from;

chats[other]=d;

});

chatList.innerHTML="";

for(const email in chats){

const last=chats[email];

const profile=await getProfile(email);

chatList.innerHTML+=`

<div class="card" onclick="openChat('${email}')">

<div class="listRow">

<img class="avatar" src="${profile.photo}">

<div>

<div class="name">${profile.name}</div>

<div class="rank">${profile.rank}</div>

<div class="last">${last.text||"Photo"}</div>

</div>

</div>

</div>

`;

}

});

}

window.openChat=async function(email){

chatUser=email;

currentChat=chatId(currentEmail,email);

const profile=await getProfile(email);

chatAvatar.src=profile.photo;

chatName.innerText=profile.name;

chatRank.innerText=profile.rank;

chatBox.style.display="flex";

loadMessages();

}

function loadMessages(){

const q=query(collection(db,"messages"),orderBy("createdAt"));

onSnapshot(q,(snap)=>{

chatArea.innerHTML="";

snap.forEach(docSnap=>{

const d=docSnap.data();

if(d.chatId!==currentChat) return;

const me=d.from===currentEmail;

const time=new Date(d.createdAt).toLocaleTimeString([],{
hour:'2-digit',
minute:'2-digit'
});

chatArea.innerHTML+=`

<div class="message ${me?'me':''}">

<div class="bubble">

${d.text||""}

${d.photo?`<img src="${d.photo}" class="chatPhoto">`:""}

<div class="time">${time}</div>

</div>

</div>

`;

});

chatArea.scrollTop=chatArea.scrollHeight;

});

}

sendBtn.onclick=async()=>{

const text=messageInput.value.trim();

const file=photoInput.files[0];

if(!text && !file) return;

let photo="";

if(file){
photo=URL.createObjectURL(file);
}

await addDoc(collection(db,"messages"),{

chatId:currentChat,
from:currentEmail,
to:chatUser,
text:text,
photo:photo,
createdAt:Date.now()

});

messageInput.value="";
photoInput.value="";

}

window.closeChat=function(){

chatBox.style.display="none";

}

</script>

</body>
</html>
