<!DOCTYPE html>
<html>
<head>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

<title>SeaConnect Messages</title>

<style>

body{
margin:0;
font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;
background:#f3f4f6;
color:#111;
}

/* HEADER */

.header{
display:flex;
align-items:center;
gap:10px;
padding:16px;
background:white;
border-bottom:1px solid #e5e7eb;
font-weight:900;
font-size:20px;
}

.header button{
border:none;
background:none;
font-size:24px;
font-weight:900;
cursor:pointer;
color:#111;
}

/* LIST */

.chatList{
padding:12px;
}

.chatItem{
display:flex;
align-items:center;
gap:12px;
background:white;
padding:14px;
border-radius:14px;
margin-bottom:10px;
cursor:pointer;
box-shadow:0 2px 8px rgba(0,0,0,.05);
}

.avatar{
width:50px;
height:50px;
border-radius:50%;
object-fit:cover;
}

.avatarWrap{
position:relative;
}

.online{
position:absolute;
bottom:2px;
right:2px;
width:12px;
height:12px;
background:#22c55e;
border-radius:50%;
border:2px solid white;
}

.name{
font-weight:900;
font-size:15px;
}

.rank{
font-size:12px;
color:#6b7280;
}

/* CHAT BOX */

.chatBox{
position:fixed;
top:0;
left:0;
right:0;
bottom:0;
background:white;
display:none;
flex-direction:column;
z-index:10;
}

/* CHAT HEADER */

.chatHeader{
display:flex;
justify-content:space-between;
align-items:center;
padding:14px;
border-bottom:1px solid #e5e7eb;
background:white;
}

.chatLeft{
display:flex;
align-items:center;
gap:10px;
}

.chatHeader img{
width:38px;
height:38px;
border-radius:50%;
object-fit:cover;
}

.chatHeader button{
border:none;
background:none;
font-size:24px;
font-weight:900;
cursor:pointer;
color:#111;
}

/* MESSAGES */

.messages{
flex:1;
overflow:auto;
padding:15px;
background:#f3f4f6;
}

.message{
margin-bottom:10px;
display:flex;
}

.me{
justify-content:flex-end;
}

.bubble{
max-width:70%;
background:white;
padding:10px 14px;
border-radius:16px;
font-size:14px;
box-shadow:0 1px 4px rgba(0,0,0,.05);
}

.me .bubble{
background:#dbeafe;
}

.chatPhoto{
max-width:200px;
border-radius:10px;
margin-top:6px;
}

/* INPUT */

.inputArea{
padding:10px;
border-top:1px solid #e5e7eb;
background:white;
}

.preview{
max-width:120px;
margin-bottom:8px;
border-radius:8px;
}

.row{
display:flex;
gap:8px;
align-items:center;
}

.row input{
flex:1;
padding:11px 14px;
border-radius:20px;
border:1px solid #ddd;
font-size:16px; /* prevents iphone zoom */
}

.row button{
border:none;
background:none;
font-size:26px;
font-weight:900;
cursor:pointer;
color:#111;
}

</style>
</head>

<body>

<div class="header">
<button onclick="location.href='friends.html'">‚Üê</button>
Messages
</div>

<div id="chatList" class="chatList"></div>

<div id="chatBox" class="chatBox">

<div class="chatHeader">

<div class="chatLeft">

<button onclick="closeChat()">‚Üê</button>

<img id="chatAvatar">

<div>
<div id="chatName" style="font-weight:900"></div>
<div id="chatRank" style="font-size:12px;color:#6b7280"></div>
</div>

</div>

<button onclick="startCall()">üìû</button>

</div>

<div id="messages" class="messages"></div>

<div class="inputArea">

<img id="preview" class="preview" style="display:none">

<div class="row">

<button id="plusBtn">Ôºã</button>

<input id="messageInput" placeholder="Type message">

<button id="sendBtn">‚Üë</button>

<input type="file" id="fileInput" accept="image/*" style="display:none">

</div>

</div>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth,onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore,collection,addDoc,onSnapshot,query,orderBy,getDocs,updateDoc,doc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig={
apiKey:"AIzaSyCNlodsmEHrSXxgH0gTOcx4cAXwG8qmG9w",
authDomain:"seaconnect-d2baa.firebaseapp.com",
projectId:"seaconnect-d2baa"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

const IMGBB_KEY="5b417e8de4a883f7425eeda12dc38f06";

/* ‚úÖ FIX: always define elements in module scripts (prevents white screen) */
const chatList = document.getElementById("chatList");
const chatBox = document.getElementById("chatBox");
const messages = document.getElementById("messages");

const chatAvatar = document.getElementById("chatAvatar");
const chatName = document.getElementById("chatName");
const chatRank = document.getElementById("chatRank");

const preview = document.getElementById("preview");
const messageInput = document.getElementById("messageInput");
const fileInput = document.getElementById("fileInput");
const sendBtn = document.getElementById("sendBtn");
const plusBtn = document.getElementById("plusBtn");

let currentEmail;
let chatUser;
let chatId;

plusBtn.onclick = () => fileInput.click();

onAuthStateChanged(auth,(user)=>{

if(!user){
location.href="index.html";
return;
}

currentEmail=user.email.toLowerCase();

loadChats();

/* ‚úÖ FIX: open chat when coming from friends.html */
const params = new URLSearchParams(window.location.search);
const openUser = params.get("user");
if(openUser){
openChat(openUser.toLowerCase());
}

});

async function getUser(email){

let name=email.split("@")[0];
let rank="";
let photo="https://i.ibb.co/2kRZ7Z6/avatar.png";

const snap=await getDocs(collection(db,"users"));

snap.forEach(d=>{

const u=d.data();

if((u.email||"").toLowerCase()===email){
name=u.name||name;
rank=u.rank||"";
photo=u.photo||photo;
}

});

return{name,rank,photo};

}

function chatKey(a,b){
return[a,b].sort().join("_");
}

/* CHAT LIST */

function loadChats(){

const q=query(collection(db,"messages"),orderBy("createdAt"));

onSnapshot(q,async(snap)=>{

const map={};

snap.forEach(d=>{

const m=d.data();

if(m.from!==currentEmail && m.to!==currentEmail)return;

const other=m.from===currentEmail?m.to:m.from;

map[other]=m;

});

chatList.innerHTML="";

for(const email in map){

const p=await getUser(email);

chatList.innerHTML+=`

<div class="chatItem" data-email="${email}">

<div class="avatarWrap">
<img class="avatar" src="${p.photo}">
<div class="online"></div>
</div>

<div>
<div class="name">${p.name}</div>
<div class="rank">${p.rank}</div>
</div>

</div>

`;

}

/* ‚úÖ click handler without inline onclick (more reliable) */
document.querySelectorAll(".chatItem").forEach(item=>{
item.onclick = () => openChat(item.getAttribute("data-email"));
});

});

}

/* OPEN CHAT */

window.openChat = async function(email){

chatUser=email;
chatId=chatKey(currentEmail,email);

const p=await getUser(email);

chatAvatar.src=p.photo;
chatName.innerText=p.name;
chatRank.innerText=p.rank;

chatBox.style.display="flex";

loadMessages();

};

/* CLOSE CHAT */

window.closeChat=function(){
chatBox.style.display="none";
};

/* CALL BUTTON */

window.startCall=function(){
alert("Call feature coming soon");
};

/* LOAD MESSAGES */

function loadMessages(){

const q=query(collection(db,"messages"),orderBy("createdAt"));

onSnapshot(q,(snap)=>{

messages.innerHTML="";

snap.forEach(d=>{

const m=d.data();

if(m.chatId!==chatId)return;

const me=m.from===currentEmail;

messages.innerHTML+=`

<div class="message ${me?'me':''}">

<div class="bubble">

${m.text||""}

${m.photo?`<img src="${m.photo}" class="chatPhoto">`:""}

</div>

</div>

`;

});

messages.scrollTop=messages.scrollHeight;

});

}

/* PREVIEW */

fileInput.onchange=function(){

const f=this.files[0];

if(!f)return;

preview.src=URL.createObjectURL(f);
preview.style.display="block";

};

/* SEND */

sendBtn.onclick=async()=>{

const text=messageInput.value.trim();
const file=fileInput.files[0];

if(!text && !file)return;

/* block sending if no chat selected */
if(!chatId || !chatUser){
alert("Open a chat first.");
return;
}

let photo="";

if(file)photo=URL.createObjectURL(file);

const ref=await addDoc(collection(db,"messages"),{

chatId:chatId,
from:currentEmail,
to:chatUser,
text:text,
photo:photo,
createdAt:Date.now()

});

messageInput.value="";
preview.style.display="none";
fileInput.value="";

/* background upload */

if(file){

const form=new FormData();
form.append("image",file);

const res=await fetch("https://api.imgbb.com/1/upload?key="+IMGBB_KEY,{
method:"POST",
body:form
});

const data=await res.json();

if(data.success){

await updateDoc(doc(db,"messages",ref.id),{
photo:data.data.url
});

}

}

};

</script>

</body>
</html>
