<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SeaConnect Messages</title>

<style>

body{
margin:0;
font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;
background:#f3f4f6;
color:#111;
}

/* HEADER */

.header{
display:flex;
align-items:center;
gap:12px;
padding:15px;
background:white;
border-bottom:1px solid #e5e7eb;
font-weight:900;
font-size:18px;
}

.header button{
background:none;
border:none;
font-size:20px;
cursor:pointer;
}

/* CHAT LIST */

.chatList{
padding:10px;
}

.chatItem{
display:flex;
align-items:center;
gap:12px;
padding:12px;
border-radius:12px;
background:white;
margin-bottom:10px;
cursor:pointer;
}

.chatItem:hover{
background:#f1f5f9;
}

.avatarWrap{
position:relative;
}

.avatar{
width:45px;
height:45px;
border-radius:50%;
object-fit:cover;
}

.onlineDot{
position:absolute;
bottom:0;
right:0;
width:10px;
height:10px;
background:#22c55e;
border-radius:50%;
border:2px solid white;
}

.name{
font-weight:700;
}

.rank{
font-size:12px;
color:#6b7280;
}

/* CHAT BOX */

.chatBox{
display:none;
height:100vh;
flex-direction:column;
}

.chatHeader{
display:flex;
align-items:center;
gap:12px;
padding:15px;
border-bottom:1px solid #e5e7eb;
background:white;
}

.chatHeader button{
background:none;
border:none;
font-size:20px;
cursor:pointer;
}

.chatMessages{
flex:1;
overflow:auto;
padding:15px;
}

.msg{
margin:8px 0;
display:flex;
}

.msg.me{
justify-content:flex-end;
}

.bubble{
padding:10px 14px;
border-radius:16px;
max-width:70%;
background:#e5e7eb;
}

.msg.me .bubble{
background:#3b82f6;
color:white;
}

.chatPhoto{
max-width:200px;
border-radius:10px;
margin-top:5px;
}

/* INPUT BAR */

.chatInput{
display:flex;
align-items:center;
gap:10px;
padding:10px;
background:white;
border-top:1px solid #e5e7eb;
}

.chatInput input{
flex:1;
padding:10px;
border-radius:20px;
border:1px solid #e5e7eb;
}

.chatInput button{
border:none;
background:none;
font-size:22px;
cursor:pointer;
}

.preview{
max-width:100px;
border-radius:8px;
margin-bottom:5px;
}

</style>
</head>

<body>

<!-- HEADER -->

<div class="header">
<button onclick="location.href='friends.html'">←</button>
Messages
</div>

<!-- CHAT LIST -->

<div id="chatList" class="chatList"></div>

<!-- CHAT BOX -->

<div id="chatBox" class="chatBox">

<div class="chatHeader">
<button id="backBtn">←</button>

<div id="chatUserName"></div>

<button style="margin-left:auto" id="closeBtn">X</button>
</div>

<div id="messages" class="chatMessages"></div>

<div style="padding:10px">
<img id="preview" class="preview" style="display:none">
</div>

<div class="chatInput">

<button onclick="fileInput.click()">+</button>

<input id="msgInput" placeholder="Type message">

<button id="sendBtn">↑</button>

<input type="file" id="fileInput" accept="image/*" style="display:none">

</div>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth,onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import {
getFirestore,
collection,
addDoc,
query,
orderBy,
onSnapshot,
getDocs,
doc,
updateDoc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig={
apiKey:"AIzaSyCNlodsmEHrSXxgH0gTOcx4cAXwG8qmG9w",
authDomain:"seaconnect-d2baa.firebaseapp.com",
projectId:"seaconnect-d2baa"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

const IMGBB_KEY="5b417e8de4a883f7425eeda12dc38f06";

let currentEmail=null;
let currentChat=null;
let chatUserEmail=null;

const chatList=document.getElementById("chatList");
const chatBox=document.getElementById("chatBox");
const messages=document.getElementById("messages");

function chatId(a,b){
return [a,b].sort().join("_");
}

/* LOGIN */

onAuthStateChanged(auth,(user)=>{

if(!user){
location.href="index.html";
return;
}

currentEmail=user.email.toLowerCase();

listenChats();

});

/* GET PROFILE */

async function getProfile(email){

let name=email.split("@")[0];
let rank="";
let photo="https://i.ibb.co/2kRZ7Z6/avatar.png";

const snap=await getDocs(collection(db,"users"));

snap.forEach(docSnap=>{
const d=docSnap.data();

if(d.email===email){
name=d.name||name;
rank=d.rank||"";
photo=d.photo||photo;
}

});

return {name,rank,photo};

}

/* CHAT LIST */

async function listenChats(){

const q=query(collection(db,"messages"),orderBy("createdAt"));

onSnapshot(q,async snap=>{

const chats={};

snap.forEach(docSnap=>{

const d=docSnap.data();

if(d.from!==currentEmail && d.to!==currentEmail) return;

const other=d.from===currentEmail?d.to:d.from;

chats[other]=true;

});

chatList.innerHTML="";

for(const email in chats){

const profile=await getProfile(email);

/* FIX NULL USERS */

if(!profile.name) continue;

chatList.innerHTML+=`

<div class="chatItem" onclick="openChat('${email}')">

<div class="avatarWrap">

<img src="${profile.photo}" class="avatar">

<div class="onlineDot"></div>

</div>

<div>

<div class="name">${profile.name}</div>

<div class="rank">${profile.rank}</div>

</div>

</div>

`;

}

});

}

/* OPEN CHAT */

window.openChat=async function(email){

chatUserEmail=email;
currentChat=chatId(currentEmail,email);

const profile=await getProfile(email);

chatUserName.innerText=profile.name+" • "+profile.rank;

chatBox.style.display="flex";

loadMessages();

};

/* LOAD MESSAGES */

function loadMessages(){

const q=query(collection(db,"messages"),orderBy("createdAt"));

onSnapshot(q,(snap)=>{

messages.innerHTML="";

snap.forEach(docSnap=>{

const d=docSnap.data();

if(d.chatId!==currentChat) return;

const me=d.from===currentEmail;

messages.innerHTML+=`

<div class="msg ${me?'me':''}">

<div class="bubble">

${d.text||""}

${d.photo?`<img src="${d.photo}" class="chatPhoto">`:""}

</div>

</div>

`;

});

messages.scrollTop=messages.scrollHeight;

});

}

/* FILE PREVIEW */

fileInput.onchange=()=>{

const file=fileInput.files[0];

if(file){

preview.src=URL.createObjectURL(file);

preview.style.display="block";

}

};

/* SEND */

sendBtn.onclick=async()=>{

const text=msgInput.value.trim();

const file=fileInput.files[0];

if(!text && !file) return;

let photoURL="";

if(file){

photoURL=URL.createObjectURL(file);

}

const ref=await addDoc(collection(db,"messages"),{

chatId:currentChat,
from:currentEmail,
to:chatUserEmail,
text:text,
photo:photoURL,
createdAt:Date.now()

});

msgInput.value="";
fileInput.value="";
preview.style.display="none";

/* upload background */

if(file){

const formData=new FormData();
formData.append("image",file);

const res=await fetch(
"https://api.imgbb.com/1/upload?key="+IMGBB_KEY,
{method:"POST",body:formData}
);

const data=await res.json();

if(data.success){

await updateDoc(doc(db,"messages",ref.id),{
photo:data.data.url
});

}

}

};

/* CLOSE CHAT */

closeBtn.onclick=()=>{
chatBox.style.display="none";
};

backBtn.onclick=()=>{
chatBox.style.display="none";
};

</script>

</body>
</html>
