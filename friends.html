<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SeaConnect - Friends</title>

<style>
body{
margin:0;
font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;
background:#f3f4f6;
color:#111;
}

/* HEADER */

.header{
display:flex;
align-items:center;
gap:12px;
padding:16px;
background:white;
border-bottom:1px solid #e5e7eb;
font-weight:700;
font-size:20px;
}
.header button{
border:none;
background:none;
font-size:26px;
font-weight:900;
cursor:pointer;
color:#111;
}

/* LIST */
.friendList{
padding:12px;
}

/* FRIEND CARD */
.friendItem{
display:flex;
align-items:center;
justify-content:space-between;
gap:12px;
background:white;
padding:14px;
border-radius:14px;
margin-bottom:10px;
box-shadow:0 2px 8px rgba(0,0,0,.05);
}

.friendLeft{
display:flex;
align-items:center;
gap:12px;
}

/* AVATAR */
.avatar{
width:50px;
height:50px;
border-radius:50%;
object-fit:cover;
}

/* NAME + RANK */
.name{
font-weight:700;
font-size:15px;
}

.rank{
font-size:12px;
color:#9ca3af;
}

/* MESSAGE BUTTON */
.messageBtn{
background:#2563eb;
color:white;
padding:8px 12px;
border-radius:10px;
font-size:12px;
font-weight:700;
border:none;
cursor:pointer;
}
.friendRow{
display:flex;
justify-content:space-between;
align-items:center;
background:white;
padding:14px;
border-radius:16px;
margin-bottom:12px;
box-shadow:0 4px 12px rgba(0,0,0,.06);
transition:transform .1s;
}

.friendRow:hover{
transform:scale(1.01);
}

.friendInfo{
display:flex;
align-items:center;
gap:12px;
}

.avatarWrapper{
position:relative;
width:50px;
height:50px;
}

.onlineDot{
position:absolute;
bottom:-2px;
right:-2px;
width:14px;
height:14px;
background:#22c55e;
border-radius:50%;
border:3px solid white;
box-shadow:0 0 6px #22c55e;
}
.avatarWrapper img{
width:50px;
height:50px;
border-radius:50%;
object-fit:cover;
}
  .container{
padding:20px;
padding-bottom:110px;
}

.card{
background:white;
padding:18px;
border-radius:16px;
margin-bottom:16px;
box-shadow:0 3px 10px rgba(0,0,0,.06);
}

.row{
display:flex;
gap:8px;
margin-top:10px;
}

.primary{
background:#2563eb;
color:white;
}

.light{
background:#e5e7eb;
color:#111;
}

.danger{
background:#ef4444;
color:white;
}
  

.primary:hover{
background:#1d4ed8;
}

.danger:hover{
background:#dc2626;
}
.primary{
background:#2563eb;
color:white;
border:none;
padding:7px 14px;
border-radius:12px;
font-size:12px;
font-weight:600;
cursor:pointer;
}

.danger{
background:#ef4444;
color:white;
border:none;
padding:7px 14px;
border-radius:12px;
font-size:12px;
font-weight:600;
cursor:pointer;
}
.bottomnav{
position:fixed;
bottom:15px;
left:50%;
transform:translateX(-50%);
width:90%;
height:65px;
background:#e5e7eb;
border-radius:22px;
display:flex;
justify-content:space-around;
align-items:center;
box-shadow:0 2px 10px rgba(0,0,0,.08);
}

.bottomnav button{
background:none;
border:none;
font-size:12px;
font-weight:600;
color:#374151;
}

.bottomnav button.active{
color:#3b82f6;
font-weight:800;
}
  input{
width:100%;
padding:12px 14px;
border-radius:12px;
border:1px solid #e5e7eb;
margin-bottom:12px;
font-size:14px;
background:#fafafa;
}
  </style>
</head>
<body>
<div class="header">
<button onclick="location.href='feeds.html'">‚Üê</button>
Friends
</div>

<div class="container">
<div class="card">
<input id="friendEmail" placeholder="Enter email to add friend">
<div class="row">
<button class="primary" id="sendBtn">Send Request</button>
<button class="light" id="resetBtn">Reset</button>
</div>
<div id="friendStatus" style="font-size:13px;color:#94a3b8;"></div>
</div>

<div id="friendsList"></div>

</div>

<div class="bottomnav">
<button onclick="location.href='feeds.html'">üì∞ Feeds</button>
<button class="active" onclick="location.href='friends.html'">üë• Friends</button>
<button onclick="location.href='message.html'">üí¨ Messages</button>
<button onclick="location.href='profile.html'">üë§ Profile</button>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import {
getFirestore,
doc,
setDoc,
getDoc,
deleteDoc,
updateDoc,
collection,
onSnapshot,
query,
where,
getDocs
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig={
apiKey:"AIzaSyCNlodsmEHrSXxgH0gTOcx4cAXwG8qmG9w",
authDomain:"seaconnect-d2baa.firebaseapp.com",
projectId:"seaconnect-d2baa"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

let currentUID=null;
let currentUserEmail=null;
let onlineUsers={};
  let lastFriendsSnap = null;
  async function setOnlineStatus(state){

const q=query(collection(db,"users"),where("email","==",currentUserEmail));
const snap=await getDocs(q);

if(snap.empty) return;

const ref=doc(db,"users",snap.docs[0].id);

await updateDoc(ref,{
online:state,
lastSeen:Date.now()
});

}
  const friendStatus = document.getElementById("friendStatus");
const friendsList = document.getElementById("friendsList");
  const friendEmail = document.getElementById("friendEmail");
  
function requestIdFor(a,b){
return [a.toLowerCase(),b.toLowerCase()].sort().join("__");
}

async function getUserByEmail(email){

const q = query(collection(db,"users"),where("email","==",email));
const snap = await getDocs(q);

if(!snap.empty){
return snap.docs[0].data();
}

return null;

}

onAuthStateChanged(auth,async(user)=>{
if(!user){location.href="index.html";return;}

currentUID = user.uid;
currentUserEmail = user.email.toLowerCase();

await setDoc(doc(db,"users",currentUID),{
email:currentUserEmail,
online:true,
lastSeen:Date.now()
},{merge:true});

listenOnlineUsers();
listenFriends();

/* heartbeat every 5 seconds */
setInterval(()=>{
  if(currentUserEmail){
    setOnlineStatus(true);
  }
},5000);

});
document.getElementById("sendBtn").onclick=async()=>{

 const input=friendEmail.value.trim().toLowerCase();
  if(!input){friendStatus.innerText="Enter email.";return;}
if(input===currentUserEmail){friendStatus.innerText="Cannot add yourself.";return;}

const rid=requestIdFor(currentUserEmail,input);
await setDoc(doc(db,"friendRequests",rid),{
from:currentUserEmail,
to:input,
status:"pending",
createdAt:Date.now()
});

friendStatus.innerText="Request sent ‚úÖ";
friendEmail.value="";
};

/* RESET BUTTON */
document.getElementById("resetBtn").onclick = ()=>{
friendEmail.value="";
friendStatus.innerText="";
};
  function listenOnlineUsers(){

  onSnapshot(collection(db,"users"),(snap)=>{

    onlineUsers={};

    snap.forEach(d=>{
      const u=d.data();
      if(u.email){
       onlineUsers[u.email.toLowerCase()] = {
  online: !!u.online,
  lastSeen: u.lastSeen || 0
};
      }
    });
 if(lastFriendsSnap){
      renderFriends(lastFriendsSnap);
    }


  });

}
function listenFriends(){

onSnapshot(collection(db,"friendRequests"),async snap=>{
  lastFriendsSnap = snap; 
renderFriends(snap);
});

}
async function renderFriends(snap){

friendsList.innerHTML="";
let incomingHTML="";
let hasIncoming=false;

for(const docSnap of snap.docs){

const r=docSnap.data();
const from=r.from?.toLowerCase();
const to=r.to?.toLowerCase();
const status=r.status;

if(from!==currentUserEmail && to!==currentUserEmail) continue;

const otherEmail=from===currentUserEmail?to:from;
const userData=await getUserByEmail(otherEmail);

const name=userData?.name||"SeaCrew";
const rank=userData?.rank||"";

if(status==="pending" && to===currentUserEmail){

hasIncoming=true;

incomingHTML+=`
<div class="friendRow">
<div class="friendInfo">

<div class="avatarWrapper">
<img src="${userData?.photo || 'https://i.ibb.co/2kRZ7Z6/avatar.png'}">
${(onlineUsers[otherEmail]?.online && (Date.now() - (onlineUsers[otherEmail]?.lastSeen || 0) < 15000))
  ? '<div class="onlineDot"></div>' : ''}

</div>

<div>
<div class="name">${name}</div>
<div class="rank">${rank}</div>
</div>

</div>

<div class="row">
<button class="primary" onclick="acceptRequest('${otherEmail}')">Accept</button>
<button class="danger" onclick="declineRequest('${otherEmail}')">Decline</button>
</div>

</div>`;
}

if(status==="accepted"){

friendsList.innerHTML+=`
<div class="card friendRow">

<div class="friendInfo">

<div class="avatarWrapper">
<img src="${userData?.photo || 'https://i.ibb.co/2kRZ7Z6/avatar.png'}">
${onlineUsers[otherEmail] ? '<div class="onlineDot"></div>' : ''}
</div>

<div>
<div class="name">${name}</div>
<div class="rank">${rank}</div>
</div>

</div>

<div class="row">
<button class="primary" onclick="openChat('${otherEmail}')">Chat</button>
<button class="danger" onclick="unfriend('${otherEmail}')">Unfriend</button>
</div>

</div>`;
}

}

if(hasIncoming){

friendsList.innerHTML =
`<div class="card"><h3>Incoming Requests</h3>${incomingHTML}</div>`
+ friendsList.innerHTML;

}

}


window.acceptRequest=async function(other){
const rid=requestIdFor(currentUserEmail,other);
await updateDoc(doc(db,"friendRequests",rid),{status:"accepted"});
};

window.declineRequest=async function(other){
const rid=requestIdFor(currentUserEmail,other);
await deleteDoc(doc(db,"friendRequests",rid));
};

window.unfriend=async function(other){
const rid=requestIdFor(currentUserEmail,other);
await deleteDoc(doc(db,"friendRequests",rid));
};

window.openChat=function(email){
location.href="message.html?user="+encodeURIComponent(email);
};
window.addEventListener("beforeunload", ()=>{
if(currentUserEmail){
setOnlineStatus(false);
}
});

document.addEventListener("visibilitychange", ()=>{
if(document.hidden){
setOnlineStatus(false);
}else{
setOnlineStatus(true);
}
});
</script>

</body>
</html>
