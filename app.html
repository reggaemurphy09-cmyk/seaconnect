<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SeaConnect Feeds</title>

<style>

body{
margin:0;
font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
background:#0f172a;
color:white;
padding:20px;
}

.card{
background:#1e293b;
padding:16px;
border-radius:14px;
margin-bottom:16px;
}

textarea{
width:100%;
padding:10px;
border-radius:10px;
border:none;
margin-top:8px;
}

input{
margin-top:8px;
}

button{
padding:8px 14px;
border:none;
border-radius:8px;
margin-top:8px;
cursor:pointer;
}

.feedPhoto{
width:100%;
border-radius:12px;
margin-top:10px;
}

.comment{
font-size:13px;
margin-top:4px;
padding:4px;
background:#334155;
border-radius:6px;
}

</style>
</head>

<body>

<h2>üì∞ Crew Feeds</h2>

<div class="card">

<textarea id="feedInput" placeholder="Share something with crew..."></textarea>

<input type="file" id="feedPhoto">

<br>

<button onclick="createFeed()">Post</button>

</div>

<div id="feedsList"></div>

<script type="module">

import { initializeApp }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";

import { getAuth,onAuthStateChanged }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
getFirestore,
collection,
addDoc,
query,
orderBy,
onSnapshot,
doc,
deleteDoc,
getDoc,
updateDoc,
where
}
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";


const firebaseConfig={
apiKey:"AIzaSyCNlodsmEHrSXxgH0gTOcx4cAXwG8qmG9w",
authDomain:"seaconnect-d2baa.firebaseapp.com",
projectId:"seaconnect-d2baa"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

let currentUID=null;
let currentName="Crew";


onAuthStateChanged(auth,async(user)=>{

if(!user){
alert("Login first");
return;
}

currentUID=user.uid;

const ref=doc(db,"users",currentUID);
const snap=await getDoc(ref);

if(snap.exists()){
currentName=snap.data().name || "Crew";
}

loadFeeds();

});


/* CREATE POST */

window.createFeed=async function(){

const text=document.getElementById("feedInput").value.trim();
const photo=document.getElementById("feedPhoto").files[0];

if(!text && !photo){
alert("Write something or upload photo");
return;
}

let photoURL="";

if(photo){

const formData=new FormData();
formData.append("image",photo);

const res=await fetch(
"https://api.imgbb.com/1/upload?key=5b417e8de4a883f7425eeda12dc38f06",
{method:"POST",body:formData});

const data=await res.json();
photoURL=data.data.url;

}

await addDoc(collection(db,"feeds"),{

uid:currentUID,
name:currentName,
text:text,
photo:photoURL,
likes:[],
createdAt:Date.now()

});

document.getElementById("feedInput").value="";
document.getElementById("feedPhoto").value="";

};


/* LOAD FEEDS */

function loadFeeds(){

const q=query(
collection(db,"feeds"),
orderBy("createdAt","desc")
);

onSnapshot(q,(snap)=>{

const list=document.getElementById("feedsList");
list.innerHTML="";

snap.forEach(docSnap=>{

const d=docSnap.data();
const id=docSnap.id;

const liked=d.likes?.includes(currentUID);

list.innerHTML+=`

<div class="card">

<b>${d.name}</b>

<div style="margin-top:6px">
${d.text || ""}
</div>

${d.photo ? `<img src="${d.photo}" class="feedPhoto">` : ""}

<div style="margin-top:10px">

<button onclick="toggleLike('${id}')">
${liked ? "üíô Liked" : "üëç Like"}
</button>

<span style="font-size:13px">
${d.likes?.length || 0} likes
</span>

${d.uid===currentUID ? `
<button onclick="deletePost('${id}')">
Delete
</button>
` : ""}

</div>

<div style="margin-top:10px">

<input id="comment-${id}" placeholder="Write comment">

<button onclick="sendComment('${id}')">
Send
</button>

</div>

<div id="comments-${id}"></div>

</div>

`;

loadComments(id);

});

});

}


/* LIKE SYSTEM */

window.toggleLike=async function(feedId){

const ref=doc(db,"feeds",feedId);
const snap=await getDoc(ref);

let likes=snap.data().likes || [];

if(likes.includes(currentUID)){
likes=likes.filter(x=>x!==currentUID);
}else{
likes.push(currentUID);
}

await updateDoc(ref,{likes:likes});

};


/* DELETE POST */

window.deletePost=async function(id){

if(confirm("Delete this post?")){
await deleteDoc(doc(db,"feeds",id));
}

};


/* SEND COMMENT */

window.sendComment=async function(feedId){

const input=document.getElementById("comment-"+feedId);
const text=input.value.trim();

if(!text)return;

await addDoc(collection(db,"comments"),{

feedId:feedId,
uid:currentUID,
name:currentName,
text:text,
createdAt:Date.now()

});

input.value="";

};


/* LOAD COMMENTS */

function loadComments(feedId){

const q=query(
collection(db,"comments"),
where("feedId","==",feedId),
orderBy("createdAt","asc")
);

onSnapshot(q,(snap)=>{

const box=document.getElementById("comments-"+feedId);
if(!box)return;

box.innerHTML="";

snap.forEach(docSnap=>{

const d=docSnap.data();

box.innerHTML+=`
<div class="comment">
<b>${d.name}</b> ${d.text}
</div>
`;

});

});

}

</script>

</body>
</html>
